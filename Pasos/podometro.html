<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrenador Pro v4</title>
    <style>
        :root {
            --primary: #00e676; /* Caminar */
            --accent: #2979ff;  /* Correr */
            --jump: #ff9100;    /* Saltar */
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --danger: #ff5252;
            --warn: #ffab00;
            --font-digital: 'Courier New', Courier, monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Cabecera */
        header {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border-bottom: 1px solid #333;
            height: 60px;
        }
        h1 { font-size: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .btn-icon { background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; }

        /* √Årea Principal */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
        }

        /* CRON√ìMETRO */
        .timer-container { text-align: center; margin-bottom: 10px; width: 100%; }
        .main-time {
            font-family: var(--font-digital);
            font-size: 3.2rem;
            font-weight: 700;
            color: var(--text);
            transition: opacity 0.3s;
        }
        .main-time.paused { opacity: 0.4; color: #666; } /* Estilo para pausa autom√°tica */
        .lap-time { font-family: var(--font-digital); font-size: 1rem; color: var(--warn); min-height: 1.5rem; }

        /* Indicador de Ritmo (SPM) */
        .spm-display {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            background: rgba(41, 121, 255, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid rgba(41, 121, 255, 0.3);
        }

        /* Contador Circular */
        .counter-container {
            width: 130px;
            height: 130px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #181818;
            border: 3px solid #333;
            margin-bottom: 15px;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }
        .step-count { font-size: 2.0rem; font-weight: 700; line-height: 1; }
        .step-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px; text-transform: uppercase; }

        /* Ajuste de Zancada */
        .calibration-panel {
            width: 100%;
            max-width: 300px;
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }
        .calib-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .calib-label { font-size: 0.7rem; color: var(--text-secondary); }
        .calib-val { font-size: 0.8rem; font-weight: bold; color: var(--primary); }
        
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; 
            background: var(--primary); cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }
        .stat-card {
            background: var(--surface);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }
        .stat-value { font-size: 1.1rem; font-weight: 600; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }

        /* Sensores */
        .sensor-viz { width: 100%; height: 30px; background: #000; border-radius: 4px; margin-bottom: 10px; position: relative; overflow: hidden; display: flex; align-items: center; }
        .sensor-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.05s linear; }
        .status-msg { font-size: 0.75rem; color: var(--text-secondary); text-align: center; font-weight: bold; min-height: 1rem; }

        /* Controles Inferiores */
        .controls {
            background: var(--surface);
            padding: 15px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 30;
        }

        .mode-selector { display: flex; background: #121212; border-radius: 8px; padding: 4px; }
        .mode-btn {
            flex: 1; border: none; background: transparent; color: var(--text-secondary);
            padding: 10px; font-size: 0.75rem; font-weight: 600; border-radius: 6px; cursor: pointer;
        }
        .mode-btn.active { background: var(--surface); color: var(--text); }
        .mode-btn.active.walk { color: var(--primary); }
        .mode-btn.active.run { color: var(--accent); }
        .mode-btn.active.jump { color: var(--jump); }

        .timer-row { display: flex; gap: 10px; }
        .btn-timer {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
        }
        .btn-lap { background: #333; color: white; border: 1px solid #555; }
        .btn-main { background: var(--primary); color: #000; }
        .btn-stop { background: var(--danger); color: white; }
        .btn-cancel { background: #666; color: white; }
        
        .btn-reset-row { display: flex; }
        .btn-reset {
            width: 100%;
            padding: 12px;
            background: #2b1d1d;
            color: var(--danger);
            border: 1px solid #553333;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <h1>Entrenador Pro v4</h1>
        <button class="btn-icon" onclick="toggleFullScreen()">‚õ∂</button>
    </header>

    <main>
        <!-- CRON√ìMETRO -->
        <div class="timer-container">
            <div class="main-time" id="main-timer">00:00.00</div>
            <div class="lap-time" id="lap-timer">Vuelta: --:--</div>
        </div>

        <!-- INDICADOR RITMO -->
        <div class="spm-display hidden" id="spm-box">üèÉ 120 Pasos/Min</div>

        <div class="counter-container" id="counter-box">
            <div class="step-count" id="count-display">0</div>
            <div class="step-label" id="main-label">Pasos</div>
        </div>

        <div class="calibration-panel" id="calib-panel">
            <div class="calib-row">
                <span class="calib-label">Zancada (Metros)</span>
                <span class="calib-val" id="stride-val">1.50 m</span>
            </div>
            <input type="range" id="stride-slider" min="0.40" max="2.50" step="0.01" value="1.50">
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-1">0.00</div>
                <div class="stat-label" id="label-1">Kil√≥metros</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-2">0</div>
                <div class="stat-label" id="label-2">Kcal</div>
            </div>
        </div>

        <div class="sensor-viz">
            <div class="sensor-bar" id="viz-bar"></div>
        </div>
        <div class="status-msg" id="debug-info">Listo</div>
    </main>

    <div class="controls">
        <div class="mode-selector">
            <button class="mode-btn walk active" onclick="setMode('walk')">üö∂ Caminar</button>
            <button class="mode-btn run" onclick="setMode('run')">üèÉ Correr</button>
            <button class="mode-btn jump" onclick="setMode('jump')">‚¨ÜÔ∏è Saltar</button>
        </div>
        
        <div class="timer-row">
            <button class="btn-timer btn-lap" id="btn-lap" onclick="doLap()" disabled>‚è∫ Vuelta</button>
            <button class="btn-timer btn-main" id="btn-main" onclick="toggleMainAction()">‚ñ∂ Iniciar</button>
        </div>

        <div class="btn-reset-row">
            <button class="btn-reset" onclick="hardReset()">‚Ü∫ RESET (Todo a 0)</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const config = {
            walk: { label: 'Pasos', s1Label: 'Kil√≥metros', s2Label: 'Kcal', color: '#00e676', threshold: 11.5, cooldown: 350, kcalPerUnit: 0.04, autoStartThreshold: 12 },
            run:  { label: 'Pasos', s1Label: 'Kil√≥metros', s2Label: 'Kcal', color: '#2979ff', threshold: 15.5, cooldown: 280, kcalPerUnit: 0.08, autoStartThreshold: 14 },
            jump: { label: 'Saltos', s1Label: 'Pico (G)', s2Label: 'Media (G)', color: '#ff9100', freeFallThreshold: 3.5, impactThreshold: 16.0, maxAirTime: 1000, autoStartThreshold: 15 }
        };

        // --- ESTADO ---
        // Estados posibles: 'IDLE', 'WAITING', 'RUNNING', 'AUTO_PAUSED', 'STOPPED'
        const state = {
            status: 'IDLE', 
            mode: 'walk',
            
            // Cron√≥metro
            timerRunning: false,
            timerStartedAt: 0,
            elapsed: 0,
            lapStart: 0,
            
            // Auto-Pause Logic
            autoPauseId: null,
            inactivityDelay: 5000, // 5 segundos sin pasos para pausar
            
            // Sensores y Datos
            count: 0,
            distance: 0,        
            calories: 0,
            strideLength: 1.50,
            
            // Cadencia (Pasos/Min)
            lastStepsTimestamps: [], // Array para suavizar c√°lculo
            
            // Sensor
            lastStepTime: 0,
            jumpState: 'GROUND',
            jumpAirStartTime: 0,
            jumpMaxPower: 0,
            jumpTotalPower: 0
        };

        // --- DOM ---
        const ui = {
            timerMain: document.getElementById('main-timer'),
            timerLap: document.getElementById('lap-timer'),
            spmBox: document.getElementById('spm-box'),
            count: document.getElementById('count-display'),
            mainLabel: document.getElementById('main-label'),
            stat1: document.getElementById('stat-1'),
            label1: document.getElementById('label-1'),
            stat2: document.getElementById('stat-2'),
            label2: document.getElementById('label-2'),
            counterBox: document.getElementById('counter-box'),
            calibPanel: document.getElementById('calib-panel'),
            strideSlider: document.getElementById('stride-slider'),
            strideVal: document.getElementById('stride-val'),
            vizBar: document.getElementById('viz-bar'),
            debug: document.getElementById('debug-info'),
            btnMain: document.getElementById('btn-main'),
            btnLap: document.getElementById('btn-lap'),
            modeBtns: document.querySelectorAll('.mode-btn')
        };

        let timerInterval;

        // --- L√ìGICA DE AUTO-PAUSA Y TIEMPO ---

        function toggleMainAction() {
            if (state.status === 'IDLE' || state.status === 'STOPPED') {
                armSystem();
            } else if (state.status === 'WAITING') {
                resetSystemUI();
            } else if (state.status === 'RUNNING') {
                stopSystem(); // Pausa Manual
            } else if (state.status === 'AUTO_PAUSED') {
                resumeSystem(); // Manual Resume si se paus√≥ auto
            }
        }

        function armSystem() {
            state.status = 'WAITING';
            ui.btnMain.textContent = "Cancelar";
            ui.btnMain.className = "btn-timer btn-cancel";
            ui.btnLap.disabled = true;
            ui.debug.textContent = "Esperando movimiento...";
            ui.debug.style.color = "var(--warn)";
            
            startSensorsOnly();
        }

        function startRunning() {
            state.status = 'RUNNING';
            state.timerRunning = true;
            state.timerStartedAt = Date.now();
            
            ui.timerMain.classList.remove('paused');
            ui.btnMain.textContent = "‚ùö‚ùö Detener";
            ui.btnMain.className = "btn-timer btn-stop";
            ui.btnLap.disabled = false;
            ui.debug.textContent = "EN MARCHA";
            ui.debug.style.color = "var(--primary)";
            
            timerInterval = setInterval(updateTimerDisplay, 30);
            
            // Activar auto-pausa si no se paus√≥ manualmente
            resetAutoPauseTimer();
        }

        function stopSystem() {
            // Pausa Manual
            state.status = 'STOPPED'; // Indica pausa manual expl√≠cita
            pauseTimerLogic();
            
            ui.btnMain.textContent = "‚ñ∂ Continuar";
            ui.btnMain.className = "btn-timer btn-main";
            ui.btnLap.disabled = true;
            ui.debug.textContent = "PAUSADO MANUAL";
            ui.debug.style.color = "#888";
            
            stopSensors(); // Opcional: detener sensores al pausar manual para bateria
        }

        function pauseSystemAuto() {
            // Pausa Autom√°tica (Smart Pause)
            state.status = 'AUTO_PAUSED';
            pauseTimerLogic();
            
            ui.timerMain.classList.add('paused'); // Visual cue
            ui.btnMain.textContent = "‚ñ∂ Reanudar";
            ui.btnMain.className = "btn-timer btn-main";
            ui.btnLap.disabled = true;
            ui.debug.textContent = "‚è∏ PAUSADO (P√°rate a descansar)";
            ui.debug.style.color = "var(--text-secondary)";
            
            // NO detener sensores, porque necesitamos detectar el reinicio
        }

        function resumeSystem() {
            // Se reanuda desde pausa manual o auto
            startRunning();
        }

        function pauseTimerLogic() {
            state.timerRunning = false;
            clearInterval(timerInterval);
            clearTimeout(state.autoPauseId); // Limpiar timeout de auto-pausa
            state.elapsed += Date.now() - state.timerStartedAt;
            updateTimerDisplay();
        }

        function resetAutoPauseTimer() {
            // Solo funciona si estamos corriendo y no en pausa manual
            if (state.status !== 'RUNNING') return;

            clearTimeout(state.autoPauseId);
            // Si no hay pasos en 5 segundos, pausar
            state.autoPauseId = setTimeout(() => {
                if (state.status === 'RUNNING') {
                    pauseSystemAuto();
                }
            }, state.inactivityDelay);
        }

        function hardReset() {
            stopSystem();
            state.status = 'IDLE';
            state.elapsed = 0;
            state.lapStart = 0;
            state.count = 0;
            state.distance = 0;
            state.calories = 0;
            state.jumpMaxPower = 0;
            state.jumpTotalPower = 0;
            state.lastStepsTimestamps = [];
            
            ui.timerMain.classList.remove('paused');
            ui.spmBox.classList.add('hidden');
            ui.btnMain.textContent = "‚ñ∂ Iniciar";
            ui.timerLap.textContent = "Vuelta: --:--";
            ui.debug.textContent = "Listo para iniciar";
            ui.debug.style.color = "var(--text-secondary)";
            
            updateTimerDisplay();
            updateStats();
        }

        // --- MANEJO DE SENSORES ---

        function startSensorsOnly() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') window.addEventListener('devicemotion', handleMotion);
                }).catch(e => console.log(e));
            } else {
                window.addEventListener('devicemotion', handleMotion);
            }
        }

        function stopSensors() {
            window.removeEventListener('devicemotion', handleMotion);
        }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const now = Date.now();
            const magnitude = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
            ui.vizBar.style.width = Math.min((magnitude / 25) * 100, 100) + '%';

            // 1. Chequeo de Auto-Start
            if (state.status === 'WAITING') {
                if (magnitude > config[state.mode].autoStartThreshold) {
                    startRunning();
                } else {
                    return; 
                }
            }

            // 2. Chequeo de Auto-Resume (si est√° en AUTO_PAUSED)
            if (state.status === 'AUTO_PAUSED') {
                if (magnitude > config[state.mode].autoStartThreshold) {
                    resumeSystem();
                }
            }

            // 3. L√≥gica Normal de Conteo
            if (state.status !== 'RUNNING') return;

            if (state.mode === 'jump') {
                processJump(magnitude, now);
            } else {
                processRunWalk(magnitude, now);
            }
        }

        // --- L√ìGICA DE PASOS Y SALTOS ---
        
        function processRunWalk(magnitude, now) {
            const conf = config[state.mode];
            if (magnitude > conf.threshold) {
                if ((now - state.lastStepTime) > conf.cooldown) {
                    registerStep(now);
                    state.lastStepTime = now;
                }
            }
        }

        function processJump(magnitude, now) {
            if (state.jumpState === 'GROUND') {
                if (magnitude < config.jump.freeFallThreshold) {
                    state.jumpState = 'AIR'; state.jumpAirStartTime = now;
                }
            } else if (state.jumpState === 'AIR') {
                if (magnitude > config.jump.impactThreshold) {
                    if ((now - state.jumpAirStartTime) < config.jump.maxAirTime) {
                        registerJump(now, magnitude);
                        state.jumpState = 'LANDED';
                        setTimeout(() => { state.jumpState = 'GROUND'; }, 500);
                    } else { state.jumpState = 'GROUND'; }
                }
                if ((now - state.jumpAirStartTime) > 800) state.jumpState = 'GROUND';
            }
        }

        function registerStep(now) {
            state.count++;
            state.distance += state.strideLength;
            state.calories += config[state.mode].kcalPerUnit;
            
            // Reiniciar timer de Auto-Pause
            resetAutoPauseTimer();
            
            // Calcular Cadencia
            calculateCadence(now);
            
            updateStats();
        }

        function registerJump(now, force) {
            state.count++;
            state.jumpTotalPower += force;
            if (force > state.jumpMaxPower) state.jumpMaxPower = force;
            
            resetAutoPauseTimer();
            calculateCadence(now); // Para mostrar Jumps/min tambi√©n
            
            updateStats();
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function calculateCadence(now) {
            // Guardar timestamp
            state.lastStepsTimestamps.push(now);
            // Mantener solo los √∫ltimos 3 pasos para suavizar
            if (state.lastStepsTimestamps.length > 3) {
                state.lastStepsTimestamps.shift();
            }

            if (state.lastStepsTimestamps.length >= 2) {
                const oldest = state.lastStepsTimestamps[0];
                const newest = state.lastStepsTimestamps[state.lastStepsTimestamps.length - 1];
                const diffMs = newest - oldest;
                
                // Pasos por minuto
                const steps = state.lastStepsTimestamps.length;
                const minutes = diffMs / 60000;
                const spm = Math.round(steps / minutes);

                // Actualizar UI
                if (state.mode === 'jump') {
                    ui.spmBox.textContent = `‚¨ÜÔ∏è ${spm} Saltos/Min`;
                } else {
                    ui.spmBox.textContent = `üèÉ ${spm} Pasos/Min`;
                }
                ui.spmBox.classList.remove('hidden');
            }
        }

        // --- VISUALIZACI√ìN Y UI ---

        function formatTime(ms) {
            const totalSec = Math.floor(ms / 1000);
            const mins = Math.floor(totalSec / 60);
            const secs = totalSec % 60;
            const centis = Math.floor((ms % 1000) / 10);
            return `${pad(mins)}:${pad(secs)}.${pad(centis)}`;
        }
        function pad(n) { return n < 10 ? '0' + n : n; }

        function updateTimerDisplay() {
            if (state.timerRunning) {
                const now = Date.now();
                const currentElapsed = state.elapsed + (now - state.timerStartedAt);
                ui.timerMain.textContent = formatTime(currentElapsed);
                const currentLap = currentElapsed - state.lapStart;
                ui.timerLap.textContent = "Vuelta: " + formatTime(currentLap);
            } else {
                ui.timerMain.textContent = formatTime(state.elapsed);
                // ui.timerLap.textContent = "Vuelta: --:--"; // Mantener √∫ltima vuelta visible
            }
        }

        function doLap() {
            if (state.status !== 'RUNNING') return;
            const now = Date.now();
            const currentElapsed = state.elapsed + (now - state.timerStartedAt);
            const lapTime = currentElapsed - state.lapStart;
            state.lapStart = currentElapsed;
            ui.timerLap.style.color = "#fff";
            setTimeout(() => ui.timerLap.style.color = "var(--warn)", 300);
            ui.debug.textContent = `Vuelta: ${formatTime(lapTime)}`;
        }

        function updateStats() {
            ui.count.textContent = state.count;
            if (state.mode === 'jump') {
                const avg = state.count > 0 ? (state.jumpTotalPower / state.count) : 0;
                ui.stat1.textContent = state.jumpMaxPower.toFixed(1);
                ui.stat2.textContent = avg.toFixed(1);
            } else {
                ui.stat1.textContent = (state.distance / 1000).toFixed(2);
                ui.stat2.textContent = Math.round(state.calories);
            }
        }

        function resetSystemUI() {
            state.status = 'IDLE';
            ui.btnMain.textContent = "‚ñ∂ Iniciar";
            ui.btnMain.className = "btn-timer btn-main";
            ui.debug.textContent = "Cancelado";
            ui.debug.style.color = "var(--text-secondary)";
            stopSensors();
        }

        function setMode(mode) {
            state.mode = mode;
            ui.modeBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn.${mode === 'jump' ? 'jump' : mode === 'run' ? 'run' : 'walk'}`).classList.add('active');

            const conf = config[mode];
            ui.mainLabel.textContent = conf.label;
            ui.label1.textContent = conf.s1Label;
            ui.label2.textContent = conf.s2Label;
            ui.counterBox.style.borderColor = conf.color;
            ui.vizBar.style.backgroundColor = conf.color;
            
            if (mode === 'jump') { ui.calibPanel.classList.add('hidden'); } 
            else {
                ui.calibPanel.classList.remove('hidden');
                if (mode === 'walk') {
                    state.strideLength = 0.75; ui.strideSlider.value = 0.75;
                } else {
                    state.strideLength = 1.50; ui.strideSlider.value = 1.50;
                }
                ui.strideVal.textContent = state.strideLength.toFixed(2) + " m";
                if(state.count > 0) { state.distance = state.count * state.strideLength; updateStats(); }
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        ui.strideSlider.addEventListener('input', (e) => {
            state.strideLength = parseFloat(e.target.value);
            ui.strideVal.textContent = state.strideLength.toFixed(2) + " m";
            if(state.count > 0 && state.mode !== 'jump') {
                state.distance = state.count * state.strideLength;
                updateStats();
            }
        });

        // Init
        setMode('run');
    </script>
</body>
</html>