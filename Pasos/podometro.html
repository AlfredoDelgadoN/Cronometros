<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrenador Pro v5</title>
    <style>
        :root {
            --primary: #00e676;
            --accent: #2979ff;
            --jump: #ff9100;
            --bg: #121212;
            --surface: #1e1e1e;
            --surface-light: #2c2c2c;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --danger: #ff5252;
            --warn: #ffab00;
            --font-digital: 'Courier New', Courier, monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border-bottom: 1px solid #333;
            height: 60px;
        }
        h1 { font-size: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .btn-icon { background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* --- MAIN --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            position: relative;
        }

        .timer-container { text-align: center; margin-bottom: 10px; width: 100%; }
        .main-time {
            font-family: var(--font-digital);
            font-size: 3.2rem;
            font-weight: 700;
            color: var(--text);
            transition: opacity 0.3s;
        }
        .main-time.paused { opacity: 0.4; color: #666; }
        .lap-time { font-family: var(--font-digital); font-size: 1rem; color: var(--warn); min-height: 1.5rem; }
        .spm-display {
            font-size: 1.1rem; font-weight: 700; color: var(--accent);
            background: rgba(41, 121, 255, 0.1); padding: 4px 12px; border-radius: 12px;
            border: 1px solid rgba(41, 121, 255, 0.3); margin-bottom: 10px;
        }

        .counter-container {
            width: 130px; height: 130px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 50%; background: #181818; border: 3px solid #333;
            margin-bottom: 15px; box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }
        .step-count { font-size: 2.0rem; font-weight: 700; line-height: 1; }
        .step-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px; text-transform: uppercase; }

        .calibration-panel {
            width: 100%; max-width: 300px; background: rgba(255,255,255,0.05);
            padding: 8px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333;
        }
        .calib-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .calib-label { font-size: 0.7rem; color: var(--text-secondary); }
        .calib-val { font-size: 0.8rem; font-weight: bold; color: var(--primary); }
        
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; 
            background: var(--primary); cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px;
        }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 10px;
        }
        .stat-card {
            background: var(--surface); padding: 10px; border-radius: 8px;
            text-align: center; border: 1px solid #333;
        }
        .stat-value { font-size: 1.1rem; font-weight: 600; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }

        .sensor-viz { width: 100%; height: 30px; background: #000; border-radius: 4px; margin-bottom: 10px; position: relative; overflow: hidden; display: flex; align-items: center; }
        .sensor-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.05s linear; }
        .status-msg { font-size: 0.75rem; color: var(--text-secondary); text-align: center; font-weight: bold; min-height: 1rem; }

        /* --- CONTROLS --- */
        .controls {
            background: var(--surface); padding: 15px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 15px; z-index: 30;
        }
        .mode-selector { display: flex; background: #121212; border-radius: 8px; padding: 4px; }
        .mode-btn {
            flex: 1; border: none; background: transparent; color: var(--text-secondary);
            padding: 10px; font-size: 0.75rem; font-weight: 600; border-radius: 6px; cursor: pointer;
        }
        .mode-btn.active { background: var(--surface); color: var(--text); }
        .mode-btn.active.walk { color: var(--primary); }
        .mode-btn.active.run { color: var(--accent); }
        .mode-btn.active.jump { color: var(--jump); }

        .timer-row { display: flex; gap: 10px; }
        .btn-timer {
            flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 1rem;
            font-weight: 700; text-transform: uppercase; cursor: pointer;
        }
        .btn-lap { background: #333; color: white; border: 1px solid #555; }
        .btn-main { background: var(--primary); color: #000; }
        .btn-stop { background: var(--danger); color: white; }
        .btn-cancel { background: #666; color: white; }
        
        .btn-reset-row { display: flex; }
        .btn-reset {
            width: 100%; padding: 12px; background: #2b1d1d; color: var(--danger);
            border: 1px solid #553333; border-radius: 8px; font-weight: 700; font-size: 0.9rem;
            text-transform: uppercase; cursor: pointer;
        }

        /* --- MODAL CONFIG --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; padding: 20px;
            overflow-y: auto; /* Permite scroll si es largo */
            transform: translateY(100%); transition: transform 0.3s ease-in-out;
        }
        .modal.open { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-title { font-size: 1.5rem; color: var(--primary); font-weight: 700; }
        .modal-close { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; }
        
        .config-section { margin-bottom: 25px; background: var(--surface); padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .config-section h3 { color: var(--accent); margin-bottom: 15px; font-size: 1rem; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .config-item { margin-bottom: 15px; }
        .config-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; color: var(--text-secondary); }
        .config-val { color: var(--primary); font-weight: bold; }
        .config-desc { font-size: 0.7rem; color: #666; margin-top: 2px; }

        .btn-save {
            width: 100%; padding: 15px; background: var(--primary); color: #000;
            border: none; border-radius: 10px; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-top: 20px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- MODAL DE CONFIGURACI√ìN -->
    <div id="settings-modal" class="modal">
        <div class="modal-header">
            <span class="modal-title">‚öôÔ∏è Configuraci√≥n</span>
            <button class="modal-close" onclick="closeSettings()">√ó</button>
        </div>

        <!-- General -->
        <div class="config-section">
            <h3>General</h3>
            <div class="config-item">
                <div class="config-label">
                    <span>‚è±Ô∏è Pausa Autom√°tica</span>
                    <span class="config-val" id="set-pause-val">5 s</span>
                </div>
                <input type="range" id="set-pause" min="1" max="30" step="1" value="5">
                <div class="config-desc">Tiempo sin movimiento para pausar el reloj.</div>
            </div>
        </div>

        <!-- Caminar / Correr -->
        <div class="config-section">
            <h3>üö∂ Caminar / üèÉ Correr</h3>
            
            <div class="config-item">
                <div class="config-label">
                    <span>‚ö° Sensibilidad Caminar</span>
                    <span class="config-val" id="set-walk-sen-val">11.5</span>
                </div>
                <input type="range" id="set-walk-sen" min="8.0" max="18.0" step="0.1" value="11.5">
                <div class="config-desc">Baja=Detecta todo | Alta=Ignora movimientos leves.</div>
            </div>

            <div class="config-item">
                <div class="config-label">
                    <span>‚ö° Sensibilidad Correr</span>
                    <span class="config-val" id="set-run-sen-val">15.5</span>
                </div>
                <input type="range" id="set-run-sen" min="10.0" max="25.0" step="0.1" value="15.5">
                <div class="config-desc">Ajusta si cuenta pasos dobles al correr r√°pido.</div>
            </div>

            <div class="config-item">
                <div class="config-label">
                    <span>‚è≥ Tiempo entre Pasos (Cooldown)</span>
                    <span class="config-val" id="set-cool-val">320 ms</span>
                </div>
                <input type="range" id="set-cool" min="150" max="800" step="10" value="320">
                <div class="config-desc">Evita conteo doble. Aumenta si cuentas 2-3 pasos por zancada.</div>
            </div>
        </div>

        <!-- Saltos -->
        <div class="config-section">
            <h3>‚¨ÜÔ∏è Saltos</h3>
            <div class="config-item">
                <div class="config-label">
                    <span>üìâ Detectar "Aire"</span>
                    <span class="config-val" id="set-jump-air-val">3.5 G</span>
                </div>
                <input type="range" id="set-jump-air" min="1.0" max="8.0" step="0.1" value="3.5">
                <div class="config-desc">Menor=detecta saltos cortos | Mayor=requiere ca√≠da libre pura.</div>
            </div>
            <div class="config-item">
                <div class="config-label">
                    <span>üìà Detectar "Impacto"</span>
                    <span class="config-val" id="set-jump-land-val">16.0 G</span>
                </div>
                <input type="range" id="set-jump-land" min="10.0" max="30.0" step="0.5" value="16.0">
                <div class="config-desc">Menor=detecta aterrizajes suaves | Mayor=solo saltos explosivos.</div>
            </div>
        </div>

        <button class="btn-save" onclick="saveSettings()">üíæ Guardar y Salir</button>
        <div style="text-align:center; margin-top:15px; font-size:0.8rem; color:#666;">
            Los cambios se guardan autom√°ticamente en el dispositivo.
        </div>
    </div>

    <!-- INTERFAZ PRINCIPAL -->
    <header>
        <h1>Entrenador Pro v5</h1>
        <div>
            <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="btn-icon" onclick="toggleFullScreen()">‚õ∂</button>
        </div>
    </header>

    <main>
        <div class="timer-container">
            <div class="main-time" id="main-timer">00:00.00</div>
            <div class="lap-time" id="lap-timer">Vuelta: --:--</div>
        </div>

        <div class="spm-display hidden" id="spm-box">üèÉ 120 Pasos/Min</div>

        <div class="counter-container" id="counter-box">
            <div class="step-count" id="count-display">0</div>
            <div class="step-label" id="main-label">Pasos</div>
        </div>

        <div class="calibration-panel" id="calib-panel">
            <div class="calib-row">
                <span class="calib-label">Zancada (Metros)</span>
                <span class="calib-val" id="stride-val">1.50 m</span>
            </div>
            <input type="range" id="stride-slider" min="0.40" max="2.50" step="0.01" value="1.50">
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-1">0.00</div>
                <div class="stat-label" id="label-1">Kil√≥metros</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-2">0</div>
                <div class="stat-label" id="label-2">Kcal</div>
            </div>
        </div>

        <div class="sensor-viz">
            <div class="sensor-bar" id="viz-bar"></div>
        </div>
        <div class="status-msg" id="debug-info">Listo</div>
    </main>

    <div class="controls">
        <div class="mode-selector">
            <button class="mode-btn walk active" onclick="setMode('walk')">üö∂ Caminar</button>
            <button class="mode-btn run" onclick="setMode('run')">üèÉ Correr</button>
            <button class="mode-btn jump" onclick="setMode('jump')">‚¨ÜÔ∏è Saltar</button>
        </div>
        
        <div class="timer-row">
            <button class="btn-timer btn-lap" id="btn-lap" onclick="doLap()" disabled>‚è∫ Vuelta</button>
            <button class="btn-timer btn-main" id="btn-main" onclick="toggleMainAction()">‚ñ∂ Iniciar</button>
        </div>

        <div class="btn-reset-row">
            <button class="btn-reset" onclick="hardReset()">‚Ü∫ RESET (Todo a 0)</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN POR DEFECTO ---
        const defaultConfig = {
            walk: { 
                label: 'Pasos', s1Label: 'Kil√≥metros', s2Label: 'Kcal', color: '#00e676', 
                threshold: 11.5, cooldown: 350, kcalPerUnit: 0.04, autoStartThreshold: 12 
            },
            run: { 
                label: 'Pasos', s1Label: 'Kil√≥metros', s2Label: 'Kcal', color: '#2979ff', 
                threshold: 15.5, cooldown: 280, kcalPerUnit: 0.08, autoStartThreshold: 14 
            },
            jump: { 
                label: 'Saltos', s1Label: 'Pico (G)', s2Label: 'Media (G)', color: '#ff9100', 
                freeFallThreshold: 3.5, impactThreshold: 16.0, maxAirTime: 1000, autoStartThreshold: 15 
            },
            general: {
                inactivityDelay: 5000 // ms
            }
        };

        // --- OBJETO CONFIG ACTIVO (Se carga desde memoria o usa defecto) ---
        const config = JSON.parse(JSON.stringify(defaultConfig));

        // --- CARGAR CONFIGURACI√ìN GUARDADA ---
        function loadSettings() {
            const saved = localStorage.getItem('entrenadorProSettings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge simple (asumimos estructura igual)
                    if(parsed.general) config.general = {...config.general, ...parsed.general};
                    if(parsed.walk) config.walk = {...config.walk, ...parsed.walk};
                    if(parsed.run) config.run = {...config.run, ...parsed.run};
                    if(parsed.jump) config.jump = {...config.jump, ...parsed.jump};
                    console.log("Configuraci√≥n cargada");
                } catch(e) { console.error("Error cargando config", e); }
            }
        }
        loadSettings();

        // --- ESTADO ---
        const state = {
            status: 'IDLE', 
            mode: 'walk',
            timerRunning: false, timerStartedAt: 0, elapsed: 0, lapStart: 0,
            autoPauseId: null,
            count: 0, distance: 0, calories: 0, strideLength: 1.50,
            lastStepTime: 0,
            jumpState: 'GROUND', jumpAirStartTime: 0, jumpMaxPower: 0, jumpTotalPower: 0,
            lastStepsTimestamps: []
        };

        // --- DOM ---
        const ui = {
            timerMain: document.getElementById('main-timer'),
            timerLap: document.getElementById('lap-timer'),
            spmBox: document.getElementById('spm-box'),
            count: document.getElementById('count-display'),
            mainLabel: document.getElementById('main-label'),
            stat1: document.getElementById('stat-1'), label1: document.getElementById('label-1'),
            stat2: document.getElementById('stat-2'), label2: document.getElementById('label-2'),
            counterBox: document.getElementById('counter-box'),
            calibPanel: document.getElementById('calib-panel'),
            strideSlider: document.getElementById('stride-slider'), strideVal: document.getElementById('stride-val'),
            vizBar: document.getElementById('viz-bar'), debug: document.getElementById('debug-info'),
            btnMain: document.getElementById('btn-main'), btnLap: document.getElementById('btn-lap'),
            modeBtns: document.querySelectorAll('.mode-btn'),
            modal: document.getElementById('settings-modal')
        };
        let timerInterval;

        // --- GESTI√ìN DE CONFIGURACI√ìN UI ---
        function openSettings() {
            ui.modal.classList.add('open');
            // Poblar inputs con valores actuales de 'config'
            document.getElementById('set-pause').value = config.general.inactivityDelay / 1000;
            document.getElementById('set-pause-val').textContent = (config.general.inactivityDelay / 1000) + ' s';

            document.getElementById('set-walk-sen').value = config.walk.threshold;
            document.getElementById('set-walk-sen-val').textContent = config.walk.threshold;

            document.getElementById('set-run-sen').value = config.run.threshold;
            document.getElementById('set-run-sen-val').textContent = config.run.threshold;

            document.getElementById('set-cool').value = config.run.cooldown; // Usamos cooldown de run como base
            document.getElementById('set-cool-val').textContent = config.run.cooldown + ' ms';

            document.getElementById('set-jump-air').value = config.jump.freeFallThreshold;
            document.getElementById('set-jump-air-val').textContent = config.jump.freeFallThreshold + ' G';
            
            document.getElementById('set-jump-land').value = config.jump.impactThreshold;
            document.getElementById('set-jump-land-val').textContent = config.jump.impactThreshold + ' G';

            // Listeners para actualizar visualmente en tiempo real dentro del modal
            setupSliderListeners();
        }

        function setupSliderListeners() {
            const link = (id, suffix) => {
                const el = document.getElementById(id);
                el.oninput = (e) => document.getElementById(id+'-val').textContent = e.target.value + ' ' + suffix;
            };
            link('set-pause', 's');
            link('set-walk-sen', '');
            link('set-run-sen', '');
            link('set-cool', ' ms');
            link('set-jump-air', ' G');
            link('set-jump-land', ' G');
        }

        function closeSettings() {
            ui.modal.classList.remove('open');
        }

        function saveSettings() {
            // Leer inputs y actualizar 'config'
            config.general.inactivityDelay = parseInt(document.getElementById('set-pause').value) * 1000;
            
            config.walk.threshold = parseFloat(document.getElementById('set-walk-sen').value);
            config.walk.autoStartThreshold = config.walk.threshold + 0.5; // Auto start ligeramente m√°s alto
            
            config.run.threshold = parseFloat(document.getElementById('set-run-sen').value);
            config.run.autoStartThreshold = config.run.threshold - 0.5;
            
            const newCooldown = parseInt(document.getElementById('set-cool').value);
            config.run.cooldown = newCooldown;
            config.walk.cooldown = newCooldown + 50; // Caminar un poco m√°s lento

            config.jump.freeFallThreshold = parseFloat(document.getElementById('set-jump-air').value);
            config.jump.impactThreshold = parseFloat(document.getElementById('set-jump-land').value);

            // Guardar en localStorage
            localStorage.setItem('entrenadorProSettings', JSON.stringify(config));
            
            closeSettings();
            showToast("Configuraci√≥n guardada");
        }

        function showToast(msg) {
            ui.debug.textContent = msg;
            setTimeout(() => { if(state.status === 'IDLE') ui.debug.textContent = "Listo para iniciar"; }, 2000);
        }

        // --- L√ìGICA PRINCIPAL (Cron√≥metro & Sensores) ---
        function toggleMainAction() {
            if (state.status === 'IDLE' || state.status === 'STOPPED') { armSystem(); }
            else if (state.status === 'WAITING') { resetSystemUI(); }
            else if (state.status === 'RUNNING') { stopSystem(); }
            else if (state.status === 'AUTO_PAUSED') { resumeSystem(); }
        }

        function armSystem() {
            state.status = 'WAITING';
            ui.btnMain.textContent = "Cancelar"; ui.btnMain.className = "btn-timer btn-cancel";
            ui.btnLap.disabled = true; ui.debug.textContent = "Esperando movimiento...";
            ui.debug.style.color = "var(--warn)";
            startSensorsOnly();
        }

        function startRunning() {
            state.status = 'RUNNING'; state.timerRunning = true; state.timerStartedAt = Date.now();
            ui.timerMain.classList.remove('paused');
            ui.btnMain.textContent = "‚ùö‚ùö Detener"; ui.btnMain.className = "btn-timer btn-stop";
            ui.btnLap.disabled = false; ui.debug.textContent = "EN MARCHA"; ui.debug.style.color = "var(--primary)";
            timerInterval = setInterval(updateTimerDisplay, 30);
            resetAutoPauseTimer();
        }

        function stopSystem() {
            state.status = 'STOPPED'; pauseTimerLogic();
            ui.btnMain.textContent = "‚ñ∂ Continuar"; ui.btnMain.className = "btn-timer btn-main";
            ui.btnLap.disabled = true; ui.debug.textContent = "PAUSADO MANUAL"; ui.debug.style.color = "#888";
            stopSensors();
        }

        function pauseSystemAuto() {
            state.status = 'AUTO_PAUSED'; pauseTimerLogic();
            ui.timerMain.classList.add('paused');
            ui.btnMain.textContent = "‚ñ∂ Reanudar"; ui.btnMain.className = "btn-timer btn-main";
            ui.btnLap.disabled = true; ui.debug.textContent = "‚è∏ PAUSADO (P√°rate a descansar)";
            ui.debug.style.color = "var(--text-secondary)";
        }

        function resumeSystem() { startRunning(); }

        function pauseTimerLogic() {
            state.timerRunning = false; clearInterval(timerInterval); clearTimeout(state.autoPauseId);
            state.elapsed += Date.now() - state.timerStartedAt; updateTimerDisplay();
        }

        function resetAutoPauseTimer() {
            if (state.status !== 'RUNNING') return;
            clearTimeout(state.autoPauseId);
            state.autoPauseId = setTimeout(() => {
                if (state.status === 'RUNNING') pauseSystemAuto();
            }, config.general.inactivityDelay);
        }

        function hardReset() {
            stopSystem(); state.status = 'IDLE'; state.elapsed = 0; state.lapStart = 0;
            state.count = 0; state.distance = 0; state.calories = 0;
            state.jumpMaxPower = 0; state.jumpTotalPower = 0; state.lastStepsTimestamps = [];
            ui.timerMain.classList.remove('paused'); ui.spmBox.classList.add('hidden');
            ui.btnMain.textContent = "‚ñ∂ Iniciar"; ui.timerLap.textContent = "Vuelta: --:--";
            ui.debug.textContent = "Listo para iniciar"; ui.debug.style.color = "var(--text-secondary)";
            updateTimerDisplay(); updateStats();
        }

        function startSensorsOnly() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') window.addEventListener('devicemotion', handleMotion);
                }).catch(e => console.log(e));
            } else { window.addEventListener('devicemotion', handleMotion); }
        }
        function stopSensors() { window.removeEventListener('devicemotion', handleMotion); }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity; if (!acc) return;
            const now = Date.now();
            const magnitude = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
            ui.vizBar.style.width = Math.min((magnitude / 25) * 100, 100) + '%';

            if (state.status === 'WAITING') {
                if (magnitude > config[state.mode].autoStartThreshold) { startRunning(); } else return;
            }
            if (state.status === 'AUTO_PAUSED') {
                if (magnitude > config[state.mode].autoStartThreshold) { resumeSystem(); }
            }
            if (state.status !== 'RUNNING') return;

            if (state.mode === 'jump') processJump(magnitude, now);
            else processRunWalk(magnitude, now);
        }

        function processRunWalk(magnitude, now) {
            const conf = config[state.mode];
            if (magnitude > conf.threshold) {
                if ((now - state.lastStepTime) > conf.cooldown) {
                    registerStep(now); state.lastStepTime = now;
                }
            }
        }
        function processJump(magnitude, now) {
            if (state.jumpState === 'GROUND') {
                if (magnitude < config.jump.freeFallThreshold) { state.jumpState = 'AIR'; state.jumpAirStartTime = now; }
            } else if (state.jumpState === 'AIR') {
                if (magnitude > config.jump.impactThreshold) {
                    if ((now - state.jumpAirStartTime) < config.jump.maxAirTime) {
                        registerJump(now, magnitude); state.jumpState = 'LANDED';
                        setTimeout(() => { state.jumpState = 'GROUND'; }, 500);
                    } else { state.jumpState = 'GROUND'; }
                }
                if ((now - state.jumpAirStartTime) > 800) state.jumpState = 'GROUND';
            }
        }

        function registerStep(now) {
            state.count++; state.distance += state.strideLength; state.calories += config[state.mode].kcalPerUnit;
            resetAutoPauseTimer(); calculateCadence(now); updateStats();
        }
        function registerJump(now, force) {
            state.count++; state.jumpTotalPower += force;
            if (force > state.jumpMaxPower) state.jumpMaxPower = force;
            resetAutoPauseTimer(); calculateCadence(now); updateStats();
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function calculateCadence(now) {
            state.lastStepsTimestamps.push(now);
            if (state.lastStepsTimestamps.length > 3) state.lastStepsTimestamps.shift();
            if (state.lastStepsTimestamps.length >= 2) {
                const diffMs = state.lastStepsTimestamps[state.lastStepsTimestamps.length-1] - state.lastStepsTimestamps[0];
                const spm = Math.round((state.lastStepsTimestamps.length * 60000) / diffMs);
                if (state.mode === 'jump') ui.spmBox.textContent = `‚¨ÜÔ∏è ${spm} Saltos/Min`;
                else ui.spmBox.textContent = `üèÉ ${spm} Pasos/Min`;
                ui.spmBox.classList.remove('hidden');
            }
        }

        function formatTime(ms) {
            const totalSec = Math.floor(ms / 1000);
            const mins = Math.floor(totalSec / 60), secs = totalSec % 60;
            const centis = Math.floor((ms % 1000) / 10);
            return `${pad(mins)}:${pad(secs)}.${pad(centis)}`;
        }
        function pad(n) { return n < 10 ? '0' + n : n; }

        function updateTimerDisplay() {
            if (state.timerRunning) {
                const now = Date.now();
                const currentElapsed = state.elapsed + (now - state.timerStartedAt);
                ui.timerMain.textContent = formatTime(currentElapsed);
                const currentLap = currentElapsed - state.lapStart;
                ui.timerLap.textContent = "Vuelta: " + formatTime(currentLap);
            } else {
                ui.timerMain.textContent = formatTime(state.elapsed);
            }
        }
        function doLap() {
            if (state.status !== 'RUNNING') return;
            const now = Date.now();
            const currentElapsed = state.elapsed + (now - state.timerStartedAt);
            const lapTime = currentElapsed - state.lapStart;
            state.lapStart = currentElapsed;
            ui.timerLap.style.color = "#fff";
            setTimeout(() => ui.timerLap.style.color = "var(--warn)", 300);
            ui.debug.textContent = `Vuelta: ${formatTime(lapTime)}`;
        }
        function updateStats() {
            ui.count.textContent = state.count;
            if (state.mode === 'jump') {
                const avg = state.count > 0 ? (state.jumpTotalPower / state.count) : 0;
                ui.stat1.textContent = state.jumpMaxPower.toFixed(1); ui.stat2.textContent = avg.toFixed(1);
            } else {
                ui.stat1.textContent = (state.distance / 1000).toFixed(2);
                ui.stat2.textContent = Math.round(state.calories);
            }
        }
        function resetSystemUI() {
            state.status = 'IDLE'; ui.btnMain.textContent = "‚ñ∂ Iniciar"; ui.btnMain.className = "btn-timer btn-main";
            ui.debug.textContent = "Cancelado"; ui.debug.style.color = "var(--text-secondary)";
            stopSensors();
        }
        function setMode(mode) {
            state.mode = mode;
            ui.modeBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn.${mode === 'jump' ? 'jump' : mode === 'run' ? 'run' : 'walk'}`).classList.add('active');
            const conf = config[mode];
            ui.mainLabel.textContent = conf.label; ui.label1.textContent = conf.s1Label;
            ui.label2.textContent = conf.s2Label; ui.counterBox.style.borderColor = conf.color;
            ui.vizBar.style.backgroundColor = conf.color;
            if (mode === 'jump') { ui.calibPanel.classList.add('hidden'); } 
            else {
                ui.calibPanel.classList.remove('hidden');
                if (mode === 'walk') { state.strideLength = 0.75; ui.strideSlider.value = 0.75; }
                else { state.strideLength = 1.50; ui.strideSlider.value = 1.50; }
                ui.strideVal.textContent = state.strideLength.toFixed(2) + " m";
                if(state.count > 0) { state.distance = state.count * state.strideLength; updateStats(); }
            }
        }
        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }
        ui.strideSlider.addEventListener('input', (e) => {
            state.strideLength = parseFloat(e.target.value);
            ui.strideVal.textContent = state.strideLength.toFixed(2) + " m";
            if(state.count > 0 && state.mode !== 'jump') {
                state.distance = state.count * state.strideLength; updateStats();
            }
        });
        setMode('run');
    </script>
</body>
</html>