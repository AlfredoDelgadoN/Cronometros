<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrenador Web Multideporte</title>
    <style>
        :root {
            --primary: #00e676; /* Caminar */
            --primary-dark: #00b248;
            --accent: #2979ff;  /* Correr */
            --jump: #ff9100;    /* Saltar (Naranja) */
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --danger: #ff5252;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            padding: 20px;
            text-align: center;
            background: var(--surface);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }

        h1 {
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        /* Contador Principal */
        .counter-container {
            position: relative;
            width: 260px;
            height: 260px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .circle-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 10px solid #2c2c2c;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.1);
            transition: border-color 0.3s;
        }

        .circle-progress {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 10px solid transparent;
            border-top-color: var(--primary);
            border-right-color: var(--primary);
            transform: rotate(-45deg);
            transition: transform 0.3s ease-out, border-color 0.3s;
            opacity: 0.5;
        }

        .step-count {
            font-size: 4.5rem;
            font-weight: 700;
            z-index: 2;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .step-label {
            position: absolute;
            bottom: 50px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }

        .stat-card {
            background: var(--surface);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 90px;
            transition: transform 0.2s;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
            transition: color 0.3s;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
            line-height: 1.2;
        }

        /* Visualizador de Fuerza */
        .sensor-viz {
            width: 100%;
            height: 60px;
            margin-top: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .sensor-bar {
            height: 4px;
            background: var(--primary);
            width: 0%;
            transition: width 0.1s linear, background-color 0.3s;
            border-radius: 2px;
        }

        .sensor-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: right;
            width: 100%;
        }

        /* Controles */
        .controls {
            background: var(--surface);
            padding: 25px 20px;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 20;
        }

        .mode-selector {
            display: flex;
            background: #121212;
            padding: 5px;
            border-radius: 10px;
            gap: 5px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 5px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .mode-btn.active {
            background: var(--surface);
            color: var(--text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .mode-btn.active.walking { color: var(--primary); }
        .mode-btn.active.running { color: var(--accent); }
        .mode-btn.active.jumping { color: var(--jump); }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: transform 0.1s;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background: var(--primary);
            color: #000;
            flex: 2;
        }

        .btn-primary.stop { background: var(--danger); color: #fff; }
        
        .btn-secondary {
            background: #333;
            color: #fff;
            flex: 1;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .stepping .circle-progress {
            transform: rotate(-45deg) scale(1.05);
            border-color: #fff;
        }

        #status-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(41, 121, 255, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
            width: 80%;
            text-align: center;
        }

    </style>
</head>
<body>

    <div id="status-toast">Mensaje del sistema</div>

    <header>
        <h1>Entrenador Web</h1>
    </header>

    <main>
        <div class="counter-container" id="counter-ui">
            <div class="circle-bg" id="circle-bg"></div>
            <div class="circle-progress" id="progress-ring"></div>
            <div class="step-count" id="step-display">0</div>
            <div class="step-label" id="main-label">Pasos</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-1-val">0.00</div>
                <div class="stat-label" id="stat-1-label">Kil칩metros</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-2-val">0</div>
                <div class="stat-label" id="stat-2-label">Kcal</div>
            </div>
        </div>

        <div class="sensor-viz">
            <div class="sensor-bar" id="sensor-bar"></div>
        </div>
        <div class="sensor-status" id="sensor-status">Esperando inicio...</div>
    </main>

    <section class="controls">
        <div class="mode-selector">
            <button class="mode-btn walking active" onclick="setMode('walk')">游뛌 Caminar</button>
            <button class="mode-btn running" onclick="setMode('run')">游끢 Correr</button>
            <button class="mode-btn jumping" onclick="setMode('jump')">拘勇 Saltar</button>
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="resetCounter()">Reset</button>
            <button class="btn btn-primary" id="toggle-btn" onclick="toggleTracking()">Iniciar</button>
        </div>
    </section>

    <script>
        // --- ESTADO DEL SISTEMA ---
        const state = {
            isRunning: false,
            mode: 'walk', // 'walk', 'run', 'jump'
            count: 0,
            distance: 0,
            calories: 0,
            maxPower: 0,
            sumPower: 0, // Suma de potencias para calcular media
            lastX: 0, lastY: 0, lastZ: 0,
            lastEventTime: 0,
            // Variables espec칤ficas para saltos
            jumpState: 'IDLE', // IDLE, LAUNCH, AIR, LAND
            jumpLaunchPeak: 0,
            jumpAirTimeStart: 0
        };

        // --- CONFIGURACI칍N POR MODO ---
        const config = {
            walk: {
                color: '#00e676',
                label: 'Pasos',
                stat1Label: 'Kil칩metros', stat1Unit: '',
                stat2Label: 'Kcal', stat2Unit: '',
                strideLength: 0.75,
                kcalPerStep: 0.04,
                threshold: 11.5,
                minDelay: 350
            },
            run: {
                color: '#2979ff',
                label: 'Pasos',
                stat1Label: 'Kil칩metros', stat1Unit: '',
                stat2Label: 'Kcal', stat2Unit: '',
                strideLength: 1.2,
                kcalPerStep: 0.08,
                threshold: 15,
                minDelay: 250
            },
            jump: {
                color: '#ff9100',
                label: 'Saltos',
                stat1Label: 'Pico M치x', stat1Unit: ' G',
                stat2Label: 'Media', stat2Unit: ' G',
                // Umbrales para salto
                launchThreshold: 2.5, // Gs para detectar impulso
                gravityThreshold: 1.2, // Por debajo de esto se considera "aire"
                minAirTime: 100, // M칤nimo ms en el aire para ser salto
                landThreshold: 2.0, // Gs para detectar aterrizaje
                cooldown: 600 // Tiempo m칤nimo entre saltos
            }
        };

        // --- REFERENCIAS UI ---
        const ui = {
            count: document.getElementById('step-display'),
            label: document.getElementById('main-label'),
            s1Val: document.getElementById('stat-1-val'),
            s1Lab: document.getElementById('stat-1-label'),
            s2Val: document.getElementById('stat-2-val'),
            s2Lab: document.getElementById('stat-2-label'),
            toggleBtn: document.getElementById('toggle-btn'),
            status: document.getElementById('sensor-status'),
            sensorBar: document.getElementById('sensor-bar'),
            toast: document.getElementById('status-toast'),
            modeBtns: document.querySelectorAll('.mode-btn'),
            container: document.getElementById('counter-ui'),
            ring: document.getElementById('progress-ring'),
            bg: document.getElementById('circle-bg')
        };

        // --- PERMISOS ---
        function requestPermission() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startListening();
                            showToast('Sensores activados');
                        } else {
                            showToast('Permiso denegado');
                            stopTracking();
                        }
                    })
                    .catch(console.error);
            } else {
                startListening();
            }
        }

        // --- CONTROL PRINCIPAL ---
        function toggleTracking() {
            if (!state.isRunning) {
                state.isRunning = true;
                ui.toggleBtn.textContent = "Detener";
                ui.toggleBtn.classList.add('stop');
                ui.status.textContent = `Midiendo ${getModeName()}...`;
                requestPermission();
            } else {
                stopTracking();
            }
        }

        function stopTracking() {
            state.isRunning = false;
            ui.toggleBtn.textContent = "Iniciar";
            ui.toggleBtn.classList.remove('stop');
            ui.status.textContent = "Pausado";
            window.removeEventListener('devicemotion', handleMotion);
        }

        function resetCounter() {
            state.count = 0;
            state.distance = 0;
            state.calories = 0;
            state.maxPower = 0;
            state.sumPower = 0;
            state.jumpState = 'IDLE';
            updateUI();
            showToast("Contadores reiniciados");
        }

        function setMode(mode) {
            state.mode = mode;
            // Actualizar botones
            ui.modeBtns.forEach(btn => btn.classList.remove('active'));
            if(mode === 'walk') document.querySelector('.walking').classList.add('active');
            if(mode === 'run') document.querySelector('.running').classList.add('active');
            if(mode === 'jump') document.querySelector('.jumping').addClass('active'); // Fix
            
            // Re-assign class properly
            ui.modeBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn.${mode === 'jump' ? 'jumping' : mode === 'run' ? 'running' : 'walking'}`).classList.add('active');

            const currentConfig = config[mode];
            
            // Actualizar UI est치tica
            ui.label.textContent = currentConfig.label;
            ui.s1Lab.textContent = currentConfig.stat1Label;
            ui.s2Lab.textContent = currentConfig.stat2Label;
            
            // Colores
            ui.ring.style.borderColor = `var(--${mode === 'jump' ? 'jump' : mode === 'run' ? 'accent' : 'primary'})`;
            ui.ring.style.borderTopColor = currentConfig.color;
            ui.ring.style.borderRightColor = currentConfig.color;
            ui.sensorBar.style.backgroundColor = currentConfig.color;

            showToast(`Modo: ${getModeName()}`);
            updateUI();
        }
        
        function getModeName() {
            if(state.mode === 'walk') return 'Caminar';
            if(state.mode === 'run') return 'Correr';
            return 'Saltar';
        }

        // --- L칍GICA DE SENSORES ---
        function startListening() {
            window.addEventListener('devicemotion', handleMotion, true);
        }

        function handleMotion(event) {
            if (!state.isRunning) return;

            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const x = acc.x;
            const y = acc.y;
            const z = acc.z;

            // Calcular magnitud total de la aceleraci칩n (Vector)
            const currentAcc = Math.sqrt(x*x + y*y + z*z);

            // Visualizaci칩n (0 a 30Gs aprox para normalizar la barra)
            const barPct = Math.min((currentAcc / 30) * 100, 100);
            ui.sensorBar.style.width = `${barPct}%`;

            if (state.mode === 'jump') {
                processJump(currentAcc);
            } else {
                processWalkRun(currentAcc);
            }

            // Actualizar lecturas anteriores
            state.lastX = x; state.lastY = y; state.lastZ = z;
        }

        // 1. L칩gica para Caminar y Correr
        function processWalkRun(currentAcc) {
            const now = Date.now();
            const conf = config[state.mode];

            // Calcular delta (cambio brusco)
            const deltaX = Math.abs(state.lastX - state.lastX); // Simplificado por magnitud directa
            const delta = Math.abs(currentAcc - 9.8); // Aproximaci칩n de movimiento (9.8 es gravedad est치tica)

            // Usamos la magnitud total simplificada vs umbral
            // La magnitud total suele oscilar entre 8 y 12 al caminar
            // Si sube por encima del umbral...
            
            // Algoritmo de cruce de cero o pico simple
            // Para simplificar en web: Detectamos picos altos
            
            if (currentAcc > conf.threshold) {
                if ((now - state.lastEventTime) > conf.minDelay) {
                    registerStep();
                    state.lastEventTime = now;
                }
            }
        }

        // 2. L칩gica para Saltos (M치quina de Estados)
        function processJump(currentAcc) {
            const now = Date.now();
            const conf = config.jump;

            switch (state.jumpState) {
                case 'IDLE':
                    // Esperar un impulso fuerte hacia arriba (aceleraci칩n > umbral)
                    if (currentAcc > conf.launchThreshold) {
                        state.jumpState = 'LAUNCH';
                        state.jumpLaunchPeak = currentAcc;
                        ui.status.textContent = "춰Despegue!";
                    }
                    break;

                case 'LAUNCH':
                    // Registramos el pico m치ximo del despegue (nuestra "potencia")
                    if (currentAcc > state.jumpLaunchPeak) {
                        state.jumpLaunchPeak = currentAcc;
                    }
                    
                    // Si la fuerza cae (entrando al aire)
                    if (currentAcc < conf.gravityThreshold) {
                        state.jumpState = 'AIR';
                        state.jumpAirTimeStart = now;
                    }
                    
                    // Si tarda mucho en entrar al aire, resetear (no fue salto)
                    if (now - state.lastEventTime > 500) state.jumpState = 'IDLE';
                    break;

                case 'AIR':
                    // Estamos en el aire si la gravedad se siente baja (ca칤da libre)
                    if (currentAcc > conf.gravityThreshold) {
                        // La gravedad volvi칩 -> probablemente aterrizamos o nos movimos mal
                        // Chequear si estuvimos el m칤nimo tiempo en el aire
                        const airDuration = now - state.jumpAirTimeStart;
                        
                        if (airDuration > conf.minAirTime) {
                            // Validar aterrizaje (debe haber impacto)
                            // Aunque en este momento ya estamos post-air, asumimos salto v치lido
                            // por la duraci칩n del aire
                            registerJump(state.jumpLaunchPeak);
                            ui.status.textContent = `춰Salto! Pico: ${state.jumpLaunchPeak.toFixed(1)}G`;
                            state.jumpState = 'IDLE';
                            state.lastEventTime = now; // Cooldown
                        } else {
                            state.jumpState = 'IDLE';
                        }
                    }
                    
                    // Timeout de seguridad por si se queda "en el aire" mucho tiempo o cae suave
                    if (now - state.jumpAirTimeStart > 1000) state.jumpState = 'IDLE';
                    break;
            }
        }

        // --- REGISTRO DE EVENTOS ---
        function registerStep() {
            const conf = config[state.mode];
            state.count++;
            state.distance += conf.strideLength;
            state.calories += conf.kcalPerStep;
            updateUI();
            triggerFeedback();
        }

        function registerJump(power) {
            state.count++;
            
            // Actualizar potencias
            if (power > state.maxPower) state.maxPower = power;
            
            // Media: (Media Anterior * (N-1) + Nuevo) / N
            // O acumulativo: sumPower / count
            state.sumPower += power;

            updateUI();
            triggerFeedback();
        }

        function updateUI() {
            ui.count.textContent = state.count;
            
            if (state.mode === 'jump') {
                const avg = state.count > 0 ? (state.sumPower / state.count) : 0;
                ui.s1Val.textContent = state.maxPower.toFixed(1);
                ui.s2Val.textContent = avg.toFixed(1);
            } else {
                ui.s1Val.textContent = (state.distance / 1000).toFixed(2);
                ui.s2Val.textContent = Math.round(state.calories);
            }
        }

        function triggerFeedback() {
            ui.container.classList.add('stepping');
            if (navigator.vibrate) navigator.vibrate(30);
            setTimeout(() => ui.container.classList.remove('stepping'), 100);
        }

        function showToast(msg) {
            ui.toast.textContent = msg;
            ui.toast.style.opacity = 1;
            setTimeout(() => ui.toast.style.opacity = 0, 2500);
        }

        // Inicializaci칩n de colores
        setMode('walk');
    </script>
</body>
</html>