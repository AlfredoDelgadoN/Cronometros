<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pod√≥metro Final</title>
    <style>
        :root {
            --primary: #00e676;
            --accent: #2979ff;
            --jump: #ff9100;
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --danger: #ff5252;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Cabecera */
        header {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border-bottom: 1px solid #333;
            height: 60px;
            z-index: 20;
        }

        h1 { font-size: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        /* √Årea Principal */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            position: relative;
        }

        /* Contador Circular */
        .counter-container {
            width: 200px;
            height: 200px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #181818;
            border: 4px solid #333;
            margin-bottom: 15px;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            transition: border-color 0.3s;
        }

        .step-count { font-size: 3.2rem; font-weight: 700; line-height: 1; }
        .step-label { font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px; text-transform: uppercase; }

        /* Ajuste de Zancada */
        .calibration-panel {
            width: 100%;
            max-width: 300px;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }
        .calib-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .calib-label { font-size: 0.75rem; color: var(--text-secondary); }
        .calib-val { font-size: 0.8rem; font-weight: bold; color: var(--primary); }
        
        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }
        .stat-card {
            background: var(--surface);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #333;
        }
        .stat-value { font-size: 1.4rem; font-weight: 600; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; text-transform: uppercase; }

        /* Sensor Viz */
        .sensor-viz { width: 100%; height: 40px; background: #000; border-radius: 8px; margin-bottom: 10px; position: relative; overflow: hidden; display: flex; align-items: center; }
        .sensor-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.05s linear; }
        .debug-text { font-size: 0.7rem; color: #666; width: 100%; text-align: right; min-height: 1rem;}

        /* Controles */
        .controls {
            background: var(--surface);
            padding: 15px;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 30;
        }

        .mode-selector { display: flex; background: #121212; border-radius: 10px; padding: 4px; }
        .mode-btn {
            flex: 1; border: none; background: transparent; color: var(--text-secondary);
            padding: 10px; font-size: 0.75rem; font-weight: 600; border-radius: 8px; cursor: pointer;
        }
        .mode-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mode-btn.active.walk { color: var(--primary); }
        .mode-btn.active.run { color: var(--accent); }
        .mode-btn.active.jump { color: var(--jump); }

        .action-row { display: flex; gap: 10px; }
        .btn-main {
            flex: 2;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #000;
            background: var(--primary);
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn-main.stop { background: var(--danger); color: white; }
        
        .btn-reset {
            flex: 1;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Cabecera con Pantalla Completa -->
    <header>
        <h1>Entrenador Web</h1>
        <button class="btn-icon" id="fs-btn" onclick="toggleFullScreen()" title="Pantalla Completa">‚õ∂</button>
    </header>

    <main>
        <div class="counter-container" id="counter-box">
            <div class="step-count" id="count-display">0</div>
            <div class="step-label" id="main-label">Pasos</div>
        </div>

        <!-- Panel de calibraci√≥n (visible solo en caminar/correr) -->
        <div class="calibration-panel" id="calib-panel">
            <div class="calib-row">
                <span class="calib-label">Zancada</span>
                <span class="calib-val" id="stride-val">0.75 m</span>
            </div>
            <input type="range" id="stride-slider" min="0.40" max="1.50" step="0.01" value="0.75">
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-1">0.00</div>
                <div class="stat-label" id="label-1">Kil√≥metros</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-2">0</div>
                <div class="stat-label" id="label-2">Kcal</div>
            </div>
        </div>

        <div class="sensor-viz">
            <div class="sensor-bar" id="viz-bar"></div>
        </div>
        <div class="debug-text" id="debug-info">Estado: Listo</div>
    </main>

    <div class="controls">
        <div class="mode-selector">
            <button class="mode-btn walk active" onclick="setMode('walk')">üö∂ Caminar</button>
            <button class="mode-btn run" onclick="setMode('run')">üèÉ Correr</button>
            <button class="mode-btn jump" onclick="setMode('jump')">‚¨ÜÔ∏è Saltar</button>
        </div>
        
        <div class="action-row">
            <button class="btn-reset" onclick="resetCounter()">‚Ü∫ Reiniciar</button>
            <button class="btn-main" id="toggle-btn" onclick="toggleTracking()">Iniciar</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const config = {
            walk: {
                label: 'Pasos',
                s1Label: 'Kil√≥metros',
                s2Label: 'Kcal',
                color: '#00e676',
                threshold: 11.5, 
                cooldown: 350, // 350ms = aprox 170 pasos por minuto max
                kcalPerUnit: 0.04
            },
            run: {
                label: 'Pasos',
                s1Label: 'Kil√≥metros',
                s2Label: 'Kcal',
                color: '#2979ff',
                threshold: 15.5, 
                // AUMENTADO a 320ms para evitar conteo doble por balanceo de brazos
                // Permite hasta ~187 pasos por minuto (sprint r√°pido)
                cooldown: 320, 
                kcalPerUnit: 0.08
            },
            jump: {
                label: 'Saltos',
                s1Label: 'Pico (G)',
                s2Label: 'Media (G)',
                color: '#ff9100',
                freeFallThreshold: 3.5, // < 3.5 se considera aire
                impactThreshold: 16.0,  // > 16 se considera impacto
                maxAirTime: 1000,      
            }
        };

        // --- ESTADO ---
        const state = {
            isRunning: false,
            mode: 'walk',
            count: 0,
            distance: 0,        
            calories: 0,
            strideLength: 0.75, 
            
            lastX: 0, lastY: 0, lastZ: 0,
            lastTime: 0,
            
            // Salto
            jumpState: 'GROUND',
            jumpAirStartTime: 0,
            jumpPeakImpact: 0,
            jumpMaxPower: 0,
            jumpTotalPower: 0
        };

        // --- DOM ---
        const ui = {
            count: document.getElementById('count-display'),
            mainLabel: document.getElementById('main-label'),
            stat1: document.getElementById('stat-1'),
            label1: document.getElementById('label-1'),
            stat2: document.getElementById('stat-2'),
            label2: document.getElementById('label-2'),
            counterBox: document.getElementById('counter-box'),
            calibPanel: document.getElementById('calib-panel'),
            strideSlider: document.getElementById('stride-slider'),
            strideVal: document.getElementById('stride-val'),
            toggleBtn: document.getElementById('toggle-btn'),
            vizBar: document.getElementById('viz-bar'),
            debug: document.getElementById('debug-info'),
            modeBtns: document.querySelectorAll('.mode-btn')
        };

        // --- FUNCIONES PRINCIPALES ---

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error intentando pantalla completa: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function resetCounter() {
            state.count = 0;
            state.distance = 0;
            state.calories = 0;
            state.jumpMaxPower = 0;
            state.jumpTotalPower = 0;
            updateUI();
            ui.debug.textContent = "Estado: Reiniciado";
        }

        function toggleTracking() {
            if (!state.isRunning) {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') start();
                            else alert("Se requiere permiso para acceder al movimiento.");
                        })
                        .catch(e => console.error(e));
                } else {
                    start();
                }
            } else {
                stop();
            }
        }

        function start() {
            state.isRunning = true;
            ui.toggleBtn.textContent = "Detener";
            ui.toggleBtn.classList.add('stop');
            ui.debug.textContent = "Estado: Rastreando...";
            window.addEventListener('devicemotion', handleMotion);
        }

        function stop() {
            state.isRunning = false;
            ui.toggleBtn.textContent = "Iniciar";
            ui.toggleBtn.classList.remove('stop');
            ui.debug.textContent = "Estado: Pausado";
            window.removeEventListener('devicemotion', handleMotion);
        }

        function setMode(mode) {
            state.mode = mode;
            
            ui.modeBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn.${mode === 'jump' ? 'jump' : mode === 'run' ? 'run' : 'walk'}`).classList.add('active');

            const conf = config[mode];
            ui.mainLabel.textContent = conf.label;
            ui.label1.textContent = conf.s1Label;
            ui.label2.textContent = conf.s2Label;
            ui.counterBox.style.borderColor = conf.color;
            ui.vizBar.style.backgroundColor = conf.color;
            ui.toggleBtn.style.backgroundColor = conf.color;

            // Mostrar slider solo si NO es salto
            if (mode === 'jump') {
                ui.calibPanel.classList.add('hidden');
            } else {
                ui.calibPanel.classList.remove('hidden');
                if (mode === 'walk') {
                    state.strideLength = 0.75;
                    ui.strideSlider.value = 0.75;
                } else {
                    state.strideLength = 1.20;
                    ui.strideSlider.value = 1.20;
                }
                ui.strideVal.textContent = state.strideLength + " m";
                // Recalcular distancia con la nueva zancada por defecto si hay pasos
                if(state.count > 0) {
                    state.distance = state.count * state.strideLength;
                    updateUI();
                }
            }
        }

        // --- EVENTOS ---
        ui.strideSlider.addEventListener('input', (e) => {
            state.strideLength = parseFloat(e.target.value);
            ui.strideVal.textContent = state.strideLength.toFixed(2) + " m";
            if(state.count > 0 && state.mode !== 'jump') {
                state.distance = state.count * state.strideLength;
                updateUI();
            }
        });

        // --- SENSORES ---
        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const now = Date.now();
            const magnitude = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);

            // Viz
            ui.vizBar.style.width = Math.min((magnitude / 25) * 100, 100) + '%';

            if (state.mode === 'jump') {
                processJump(magnitude, now);
            } else {
                processRunWalk(magnitude, now);
            }
        }

        function processRunWalk(magnitude, now) {
            const conf = config[state.mode];
            if (magnitude > conf.threshold) {
                if ((now - state.lastTime) > conf.cooldown) {
                    registerStep();
                    state.lastTime = now;
                }
            }
        }

        function processJump(magnitude, now) {
            if (state.jumpState === 'GROUND') {
                if (magnitude < config.jump.freeFallThreshold) {
                    state.jumpState = 'AIR';
                    state.jumpAirStartTime = now;
                    ui.debug.textContent = "Estado: Aire";
                }
            } else if (state.jumpState === 'AIR') {
                if (magnitude > config.jump.impactThreshold) {
                    if ((now - state.jumpAirStartTime) < config.jump.maxAirTime) {
                        registerJump(magnitude);
                        state.jumpState = 'LANDED';
                        ui.debug.textContent = "Estado: Impacto!";
                        setTimeout(() => { state.jumpState = 'GROUND'; }, 500);
                    } else {
                        state.jumpState = 'GROUND';
                    }
                }
                if ((now - state.jumpAirStartTime) > 800) state.jumpState = 'GROUND';
            }
        }

        function registerStep() {
            state.count++;
            state.distance += state.strideLength;
            state.calories += config[state.mode].kcalPerUnit;
            updateUI();
        }

        function registerJump(impactForce) {
            state.count++;
            state.jumpTotalPower += impactForce;
            if (impactForce > state.jumpMaxPower) state.jumpMaxPower = impactForce;
            updateUI();
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function updateUI() {
            ui.count.textContent = state.count;
            if (state.mode === 'jump') {
                const avg = state.count > 0 ? (state.jumpTotalPower / state.count) : 0;
                ui.stat1.textContent = state.jumpMaxPower.toFixed(1);
                ui.stat2.textContent = avg.toFixed(1);
            } else {
                ui.stat1.textContent = (state.distance / 1000).toFixed(2);
                ui.stat2.textContent = Math.round(state.calories);
            }
        }

        setMode('walk');
    </script>
</body>
</html>