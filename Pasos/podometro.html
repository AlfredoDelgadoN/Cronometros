<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pod贸metro Pro Ajustable</title>
    <style>
        :root {
            --primary: #00e676; /* Caminar */
            --accent: #2979ff;  /* Correr */
            --jump: #ff9100;    /* Saltar */
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --danger: #ff5252;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            padding: 15px;
            text-align: center;
            background: var(--surface);
            border-bottom: 1px solid #333;
            z-index: 10;
        }

        h1 { font-size: 1.1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        /* Contador */
        .counter-container {
            width: 220px;
            height: 220px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #181818;
            border: 4px solid #333;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: border-color 0.3s;
        }

        .step-count { font-size: 3.5rem; font-weight: 700; line-height: 1; }
        .step-label { font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; text-transform: uppercase; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #333;
        }

        .stat-value { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }

        /* Slider de Ajuste */
        .calibration-panel {
            width: 100%;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .calibration-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            margin-top: -8px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #444;
            border-radius: 2px;
        }

        /* Sensores Viz */
        .sensor-viz {
            width: 100%;
            height: 40px;
            background: #000;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        .sensor-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s; }

        /* Controles Inferiores */
        .controls {
            background: var(--surface);
            padding: 20px;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mode-selector {
            display: flex;
            background: #121212;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            padding: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
        }

        .mode-btn.active {
            background: var(--surface);
            color: var(--text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .mode-btn.active.walk { color: var(--primary); }
        .mode-btn.active.run { color: var(--accent); }
        .mode-btn.active.jump { color: var(--jump); }

        .action-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #000;
            background: var(--primary);
            cursor: pointer;
            text-transform: uppercase;
        }
        .action-btn.stop { background: var(--danger); color: white; }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(41, 121, 255, 0.9); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 100;
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="toast">Mensaje</div>

    <header>
        <h1>Pod贸metro & Potencia</h1>
    </header>

    <main>
        <div class="counter-container" id="counter-box">
            <div class="step-count" id="count-display">0</div>
            <div class="step-label" id="main-label">Pasos</div>
        </div>

        <div class="calibration-panel" id="calib-panel">
            <div class="calibration-label">
                <span>Ajuste de Zancada</span>
                <span id="stride-val">0.75 m</span>
            </div>
            <!-- Slider para ajustar la distancia por paso -->
            <input type="range" id="stride-slider" min="0.40" max="1.50" step="0.01" value="0.75">
            <div style="font-size: 0.7rem; color: #666; margin-top: 5px; text-align: center;">
                Ajusta si la distancia no es exacta
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-1">0.00</div>
                <div class="stat-label" id="label-1">Kil贸metros</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-2">0</div>
                <div class="stat-label" id="label-2">Kcal</div>
            </div>
        </div>

        <div class="sensor-viz">
            <div class="sensor-bar" id="viz-bar"></div>
        </div>
        <div style="font-size: 0.75rem; color: #666; width: 100%; text-align: right;" id="debug-info">Estado: Listo</div>
    </main>

    <div class="controls">
        <div class="mode-selector">
            <button class="mode-btn walk active" onclick="setMode('walk')"> Caminar</button>
            <button class="mode-btn run" onclick="setMode('run')"> Correr</button>
            <button class="mode-btn jump" onclick="setMode('jump')">猬锔 Saltar</button>
        </div>
        <button class="action-btn" id="toggle-btn" onclick="toggleTracking()">Iniciar Rastreo</button>
    </div>

    <script>
        // --- CONFIGURACIN ---
        const config = {
            walk: {
                label: 'Pasos',
                s1Label: 'Kil贸metros',
                s2Label: 'Kcal',
                color: '#00e676',
                threshold: 11.5, // Sensibilidad
                cooldown: 350,
                kcalPerUnit: 0.04
            },
            run: {
                label: 'Pasos',
                s1Label: 'Kil贸metros',
                s2Label: 'Kcal',
                color: '#2979ff',
                threshold: 14, // Sensibilidad
                cooldown: 250,
                kcalPerUnit: 0.08
            },
            jump: {
                label: 'Saltos',
                s1Label: 'Pico (G)',
                s2Label: 'Media (G)',
                color: '#ff9100',
                // Umbrales nuevos para el m茅todo de "Ca铆da Libre"
                freeFallThreshold: 3.0, // Menos de esto es aire (0G aprox + ruido)
                impactThreshold: 15.0,  // M谩s de esto es aterrizaje fuerte
                maxAirTime: 1000,      // ms
            }
        };

        // --- ESTADO ---
        const state = {
            isRunning: false,
            mode: 'walk',
            count: 0,
            distance: 0,        // Metros
            calories: 0,
            
            // Variables de ajuste
            strideLength: 0.75, // Por defecto (ajustable con slider)
            
            // Variables temporales de sensor
            lastX: 0, lastY: 0, lastZ: 0,
            lastTime: 0,
            
            // Variables de Salto (Nuevo Algoritmo)
            jumpState: 'GROUND', // GROUND, AIR, LANDED
            jumpAirStartTime: 0,
            jumpPeakImpact: 0,
            jumpMaxPower: 0,
            jumpTotalPower: 0
        };

        // --- DOM ---
        const ui = {
            count: document.getElementById('count-display'),
            mainLabel: document.getElementById('main-label'),
            stat1: document.getElementById('stat-1'),
            label1: document.getElementById('label-1'),
            stat2: document.getElementById('stat-2'),
            label2: document.getElementById('label-2'),
            counterBox: document.getElementById('counter-box'),
            calibPanel: document.getElementById('calib-panel'),
            strideSlider: document.getElementById('stride-slider'),
            strideVal: document.getElementById('stride-val'),
            toggleBtn: document.getElementById('toggle-btn'),
            vizBar: document.getElementById('viz-bar'),
            debug: document.getElementById('debug-info'),
            toast: document.getElementById('toast'),
            modeBtns: document.querySelectorAll('.mode-btn')
        };

        // --- LGICA PRINCIPAL ---

        function toggleTracking() {
            if (!state.isRunning) {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') start();
                            else alert("Permiso necesario");
                        })
                        .catch(e => console.error(e));
                } else {
                    start();
                }
            } else {
                stop();
            }
        }

        function start() {
            state.isRunning = true;
            ui.toggleBtn.textContent = "Detener";
            ui.toggleBtn.classList.add('stop');
            ui.debug.textContent = "Estado: Rastreando...";
            window.addEventListener('devicemotion', handleMotion);
        }

        function stop() {
            state.isRunning = false;
            ui.toggleBtn.textContent = "Iniciar Rastreo";
            ui.toggleBtn.classList.remove('stop');
            ui.debug.textContent = "Estado: Pausado";
            window.removeEventListener('devicemotion', handleMotion);
        }

        function setMode(mode) {
            state.mode = mode;
            
            // Actualizar UI botones
            ui.modeBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn.${mode === 'jump' ? 'jump' : mode === 'run' ? 'run' : 'walk'}`).classList.add('active');

            // Actualizar colores y textos
            const conf = config[mode];
            ui.mainLabel.textContent = conf.label;
            ui.label1.textContent = conf.s1Label;
            ui.label2.textContent = conf.s2Label;
            ui.counterBox.style.borderColor = conf.color;
            ui.vizBar.style.backgroundColor = conf.color;
            ui.toggleBtn.style.backgroundColor = conf.color;

            // Mostrar/Ocultar slider de zancada (Solo en caminar/correr)
            if (mode === 'jump') {
                ui.calibPanel.classList.add('hidden');
            } else {
                ui.calibPanel.classList.remove('hidden');
                // Resetear slider a valores por defecto si cambia de modo
                if (mode === 'walk') {
                    state.strideLength = 0.75;
                    ui.strideSlider.value = 0.75;
                } else if (mode === 'run') {
                    state.strideLength = 1.20;
                    ui.strideSlider.value = 1.20;
                }
                ui.strideVal.textContent = state.strideLength + " m";
            }
        }

        // --- EVENTO DEL SLIDER ---
        ui.strideSlider.addEventListener('input', (e) => {
            state.strideLength = parseFloat(e.target.value);
            ui.strideVal.textContent = state.strideLength.toFixed(2) + " m";
            // Recalcular distancia basada en pasos actuales
            if(state.mode !== 'jump') {
                const newDist = state.count * state.strideLength;
                state.distance = newDist;
                updateUI();
            }
        });

        // --- MANEJO DE SENSORES ---
        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const now = Date.now();
            const x = acc.x; const y = acc.y; const z = acc.z;

            // Calcular Magnitud Vectorial (Total de fuerza)
            // Gravity es ~9.8. En reposo esto da ~10. En ca铆da libre da ~0.
            const magnitude = Math.sqrt(x*x + y*y + z*z);

            // Visualizador (Normalizado entre 0 y 25G)
            ui.vizBar.style.width = Math.min((magnitude / 25) * 100, 100) + '%';

            if (state.mode === 'jump') {
                processJumpLogic(magnitude, now);
            } else {
                processWalkRunLogic(magnitude, now);
            }
        }

        // 1. L贸gica Caminar/Correr
        function processWalkRunLogic(magnitude, now) {
            const conf = config[state.mode];

            // Detecci贸n simple de pico
            if (magnitude > conf.threshold) {
                // Evitar rebote (debounce)
                if ((now - state.lastTime) > conf.cooldown) {
                    registerStepRun();
                    state.lastTime = now;
                }
            }
        }

        // 2. L贸gica Saltar (M茅todo Ca铆da Libre + Impacto)
        function processJumpLogic(magnitude, now) {
            // Magnitud cerca de 0 = Ca铆da Libre (Aire). Magnitud > 15 = Impacto fuerte.
            
            if (state.jumpState === 'GROUND') {
                // Esperando ca铆da libre
                if (magnitude < config.jump.freeFallThreshold) {
                    state.jumpState = 'AIR';
                    state.jumpAirStartTime = now;
                    ui.debug.textContent = "Estado: En el aire...";
                }
            } 
            else if (state.jumpState === 'AIR') {
                // Estamos en el aire, esperando aterrizaje o timeout
                if (magnitude > config.jump.impactThreshold) {
                    // 隆IMPACTO! Aterrizaje detectado
                    if ((now - state.jumpAirStartTime) < config.jump.maxAirTime) {
                        // Validado como salto
                        registerJump(magnitude); // 'magnitude' aqu铆 es la fuerza del impacto
                        state.jumpState = 'LANDED';
                        ui.debug.textContent = "Estado: Aterrizaje!";
                        
                        // Peque帽o cooldown para evitar rebotes
                        setTimeout(() => { state.jumpState = 'GROUND'; }, 500);
                    } else {
                        // Demasiado tiempo en el aire, quiz谩s se tir贸 el celular? Reset
                        state.jumpState = 'GROUND';
                    }
                }
                
                // Timeout: Si pasamos mucho tiempo y no hubo impacto fuerte (salto suave)
                if ((now - state.jumpAirStartTime) > 800) {
                    // Asumimos que cay贸 suavemente, count como salto si fue tiempo suficiente
                    if (magnitude < 10) { // Si sigue bajito, asumimos que seguimos cayendo o aterrizamos suave
                         // Para saltos suaves sin impacto fuerte, podr铆amos contar aqu铆 si quisi茅ramos,
                         // pero por ahora priorizamos saltos fuertes.
                    }
                    state.jumpState = 'GROUND';
                }
            }
        }

        // --- REGISTROS Y CLCULOS ---

        function registerStepRun() {
            state.count++;
            state.distance += state.strideLength; // Usamos la variable del slider
            state.calories += config[state.mode].kcalPerUnit;
            updateUI();
        }

        function registerJump(impactForce) {
            state.count++;
            
            // Potencia estimada basada en el impacto (fuerza G)
            state.jumpTotalPower += impactForce;
            if (impactForce > state.jumpMaxPower) state.jumpMaxPower = impactForce;

            updateUI();
            
            // Vibraci贸n fuerte para feedback
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function updateUI() {
            ui.count.textContent = state.count;
            
            if (state.mode === 'jump') {
                // Modo Salto: Estad铆sticas de Potencia
                const avg = state.count > 0 ? (state.jumpTotalPower / state.count) : 0;
                ui.stat1.textContent = state.jumpMaxPower.toFixed(1);
                ui.stat2.textContent = avg.toFixed(1);
            } else {
                // Modo Caminar/Correr: Distancia y Kcal
                ui.stat1.textContent = (state.distance / 1000).toFixed(2); // Km
                ui.stat2.textContent = Math.round(state.calories);
            }
        }
        
        // Inicializar UI
        setMode('walk');

    </script>
</body>
</html>