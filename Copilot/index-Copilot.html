<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Cronómetro GPS Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    body {
      background: #0f0f15;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 8px;
    }
    .display {
      text-align: center;
      padding: 8px 0;
      font-size: 1.1rem;
    }
    .main-time {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 4px 0;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin: 8px 0;
      font-size: 0.9rem;
    }
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: auto;
      padding: 12px 0;
    }
    button {
      background: #222;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 14px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      transition: background 0.2s;
    }
    button:active {
      background: #444;
    }
    #lapBtn {
      position: relative;
    }
    .lap-options {
      position: absolute;
      top: -40px;
      right: 4px;
      background: #ff4d4d;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    #map {
      width: 100%;
      height: 120px;
      background: #1a1a25;
      border-radius: 8px;
      margin: 8px 0;
      border: 1px solid #333;
    }
    #lapsList {
      max-height: 100px;
      overflow-y: auto;
      font-size: 0.85rem;
      margin-top: 8px;
    }
    .lap-entry {
      padding: 4px 0;
      border-bottom: 1px solid #333;
    }
    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85);
      color: #4caf50;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .transport {
      font-size: 1rem;
      color: #4caf50;
      margin: 4px 0;
    }
  </style>
</head>
<body>

  <div class="display">
    <div class="transport" id="transport">Estado: Esperando GPS...</div>
    <div class="main-time" id="timer">00:00:00</div>
    <div class="stats">
      <div>Dist: <span id="distance">0.00 km</span></div>
      <div>Vel: <span id="speed">0.0</span> km/h</div>
      <div>Prom: <span id="avgSpeed">0.0</span> km/h</div>
    </div>
  </div>

  <canvas id="map"></canvas>

  <div id="lapsList"></div>

  <div class="btn-group">
    <button id="startBtn">▶ Iniciar</button>
    <button id="lapBtn">
      LAP
      <div class="lap-options" id="lapToggle">A</div>
    </button>
  </div>

  <div class="notification" id="lapNotify"></div>

  <audio id="lapSound" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt55lGCBhmut7wpFwLG2Gu5vK6aw0aaK3n8L5wDxtoq+XyuW4QH2iq5O+2bA8jaa3m7rNlDSZqruXvr2INJ2ut5O2tYAwmaq7k7KxeDCVrruPsq1wLJGuv4uupWgokbLDi66dZCSNtsOHqp1YJIG6x4OmkVAcd" preload="auto"></audio>

  <script>
    // Configuración
    let lapAuto = true;
    let lapTrigger = 'time'; // 'time' o 'distance'
    let lapValue = 60; // segundos o km
    let startTime = null;
    let lastPos = null;
    let totalDistance = 0;
    let lastLapTime = null;
    let lastLapDistance = 0;
    let positions = [];
    let watchId = null;
    let isRunning = false;
    let totalTime = 0;

    const elTimer = document.getElementById('timer');
    const elDistance = document.getElementById('distance');
    const elSpeed = document.getElementById('speed');
    const elAvgSpeed = document.getElementById('avgSpeed');
    const elTransport = document.getElementById('transport');
    const elLaps = document.getElementById('lapsList');
    const elLapNotify = document.getElementById('lapNotify');
    const elLapSound = document.getElementById('lapSound');
    const elLapToggle = document.getElementById('lapToggle');
    const canvas = document.getElementById('map');
    const ctx = canvas.getContext('2d');

    // Botones
    document.getElementById('startBtn').addEventListener('click', toggleTracking);
    document.getElementById('lapBtn').addEventListener('click', manualLap);
    elLapToggle.addEventListener('click', toggleLapMode);

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      redrawMap();
    }

    function toggleLapMode(e) {
      e.stopPropagation();
      lapAuto = !lapAuto;
      elLapToggle.textContent = lapAuto ? 'A' : 'M';
      elLapToggle.style.background = lapAuto ? '#4caf50' : '#ff4d4d';
    }

    function toggleTracking() {
      if (!isRunning) {
        startTracking();
      } else {
        stopTracking();
      }
    }

    function startTracking() {
      if (!navigator.geolocation) {
        alert('Geolocalización no soportada');
        return;
      }
      isRunning = true;
      startTime = Date.now();
      lastLapTime = startTime;
      totalTime = 0;
      totalDistance = 0;
      lastLapDistance = 0;
      positions = [];
      document.getElementById('startBtn').textContent = '⏹ Detener';
      watchId = navigator.geolocation.watchPosition(onPositionUpdate, onGeolocationError, {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 10000
      });
      updateTimer();
    }

    function stopTracking() {
      isRunning = false;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      document.getElementById('startBtn').textContent = '▶ Iniciar';
    }

    function onPositionUpdate(pos) {
      const now = Date.now();
      const coords = pos.coords;
      const lat = coords.latitude;
      const lng = coords.longitude;

      if (!lastPos) {
        lastPos = { lat, lng, time: now };
        positions.push({ lat, lng });
        return;
      }

      // Calcular distancia (en metros)
      const R = 6371000; // Radio de la Tierra en metros
      const φ1 = lastPos.lat * Math.PI / 180;
      const φ2 = lat * Math.PI / 180;
      const Δφ = (lat - lastPos.lat) * Math.PI / 180;
      const Δλ = (lng - lastPos.lng) * Math.PI / 180;
      const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c;

      totalDistance += distance;
      const timeDiff = (now - lastPos.time) / 1000; // en segundos
      const speed = timeDiff > 0 ? (distance / 1000) / (timeDiff / 3600) : 0; // km/h

      // Estimación de modo de transporte
      let transport = 'Detenido';
      if (speed > 1 && speed < 6) transport = 'Caminando';
      else if (speed >= 6 && speed < 20) transport = 'En bici';
      else if (speed >= 20 && speed < 80) transport = 'En auto';
      else if (speed >= 80) transport = 'Rápido (auto/avión?)';
      elTransport.textContent = `Modo: ${transport}`;

      // Actualizar UI
      elDistance.textContent = (totalDistance / 1000).toFixed(2) + ' km';
      elSpeed.textContent = speed.toFixed(1);
      const elapsed = (now - startTime) / 1000;
      const avgSpeed = elapsed > 0 ? (totalDistance / 1000) / (elapsed / 3600) : 0;
      elAvgSpeed.textContent = avgSpeed.toFixed(1);

      // Guardar posición
      positions.push({ lat, lng });
      redrawMap();

      // Chequear LAP automático
      if (lapAuto) {
        if (lapTrigger === 'time' && (now - lastLapTime) / 1000 >= lapValue) {
          recordLap();
        } else if (lapTrigger === 'distance' && (totalDistance - lastLapDistance) / 1000 >= lapValue) {
          recordLap();
        }
      }

      lastPos = { lat, lng, time: now };
    }

    function onGeolocationError(err) {
      console.error('Error GPS:', err);
      elTransport.textContent = 'Error GPS: ' + err.message;
    }

    function manualLap() {
      if (isRunning) recordLap();
    }

    function recordLap() {
      const now = Date.now();
      const lapTime = (now - lastLapTime) / 1000;
      const lapDist = (totalDistance - lastLapDistance) / 1000; // km
      const lapPace = lapDist > 0 ? lapTime / 60 / lapDist : 0; // min/km

      const lapItem = document.createElement('div');
      lapItem.className = 'lap-entry';
      lapItem.textContent = `Lap ${elLaps.children.length + 1}: ${formatTime(lapTime)} | ${lapDist.toFixed(2)} km | ${lapPace.toFixed(2)} min/km`;
      elLaps.prepend(lapItem);

      // Notificación
      elLapNotify.textContent = `Lap: ${formatTime(lapTime)} | ${lapDist.toFixed(2)} km`;
      elLapNotify.style.opacity = '1';
      setTimeout(() => elLapNotify.style.opacity = '0', 6000);

      // Sonido
      elLapSound.currentTime = 0;
      elLapSound.play().catch(e => console.log('Sonido bloqueado:', e));

      lastLapTime = now;
      lastLapDistance = totalDistance;
    }

    function updateTimer() {
      if (!isRunning) return;
      const elapsed = Date.now() - startTime;
      elTimer.textContent = formatTime(elapsed / 1000);
      requestAnimationFrame(updateTimer);
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return (h > 0 ? `${h.toString().padStart(2, '0')}:` : '') +
             `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function redrawMap() {
      if (positions.length < 2) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.strokeStyle = '#4caf50';
      ctx.lineWidth = 2;

      // Normalizar coordenadas al canvas
      const lats = positions.map(p => p.lat);
      const lngs = positions.map(p => p.lng);
      const minLat = Math.min(...lats), maxLat = Math.max(...lats);
      const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);
      const latRange = maxLat - minLat || 1;
      const lngRange = maxLng - minLng || 1;

      for (let i = 0; i < positions.length; i++) {
        const x = canvas.width * (positions[i].lng - minLng) / lngRange;
        const y = canvas.height * (1 - (positions[i].lat - minLat) / latRange);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
    }
  </script>
</body>
</html>